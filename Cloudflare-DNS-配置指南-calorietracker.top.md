# 🌐 Cloudflare DNS配置指南 - calorietracker.top

## 📋 概览

本指南将帮您完成 `calorietracker.top` 域名在Cloudflare上的DNS配置，实现：
- ✅ 免费SSL证书
- ✅ 全球CDN加速  
- ✅ DDoS防护
- ✅ 性能优化

---

## 🚀 第一步：添加域名到Cloudflare

### 1. 访问Cloudflare控制台
```
https://dash.cloudflare.com
```

### 2. 添加站点
1. 点击 **"添加站点"** 按钮
2. 输入域名：`calorietracker.top`
3. 选择 **"免费"** 计划
4. 点击 **"继续"**

### 3. DNS扫描
Cloudflare会自动扫描现有DNS记录，等待扫描完成。

---

## 🔧 第二步：配置DNS记录

### 必需的DNS记录配置

| 类型 | 名称 | 内容 | 代理状态 | TTL | 说明 |
|------|------|------|---------|-----|------|
| A | @ | 59.110.150.196 | 🟠 已代理 | 自动 | 根域名解析 |
| A | www | 59.110.150.196 | 🟠 已代理 | 自动 | www子域名 |
| CNAME | * | calorietracker.top | 🟠 已代理 | 自动 | 通配符解析 |

### 可选的DNS记录

| 类型 | 名称 | 内容 | 代理状态 | TTL | 说明 |
|------|------|------|---------|-----|------|
| A | api | 59.110.150.196 | 🟠 已代理 | 自动 | API专用域名 |
| A | admin | 59.110.150.196 | 🟠 已代理 | 自动 | 管理后台 |

### 🔍 配置说明

**🟠 代理状态（重要）**
- **已代理**：流量经过Cloudflare，获得SSL、CDN、安全防护
- **仅DNS**：直接解析到服务器，失去Cloudflare功能

**⚠️ 注意：所有记录都应该开启代理状态！**

---

## 🔄 第三步：更新域名服务器

### 1. 获取Cloudflare名称服务器
在Cloudflare控制台中，您会看到类似：
```
alia.ns.cloudflare.com
bert.ns.cloudflare.com
```

### 2. 在阿里云修改DNS服务器
1. 登录 [阿里云控制台](https://dc.console.aliyun.com)
2. 进入 **"域名控制台"**
3. 找到 `calorietracker.top`
4. 点击 **"管理"**
5. 点击 **"DNS修改"**
6. 将DNS服务器改为Cloudflare提供的地址

### 3. 等待生效
- DNS传播通常需要 **2-24小时**
- 可以通过 `nslookup calorietracker.top` 验证

---

## 🔒 第四步：SSL/TLS配置

### 1. 访问SSL/TLS设置
在Cloudflare控制台：
1. 选择您的域名
2. 点击 **"SSL/TLS"** 选项卡

### 2. 选择加密模式
**推荐配置：完全（严格）**

| 模式 | 说明 | 推荐度 |
|------|------|--------|
| 关闭 | 不使用SSL | ❌ 不推荐 |
| 灵活 | 用户到CF使用HTTPS，CF到源服务器HTTP | ⚠️ 不安全 |
| 完全 | 端到端HTTPS，接受自签名证书 | ✅ 推荐 |
| 完全（严格） | 端到端HTTPS，需要有效证书 | ⭐ 最佳 |

### 3. 启用其他SSL功能
- ✅ **始终使用HTTPS**：自动重定向HTTP到HTTPS
- ✅ **自动HTTPS重写**：自动修复混合内容
- ✅ **最小TLS版本**：设置为TLS 1.2

---

## ⚡ 第五步：性能优化

### 1. 缓存配置
在 **"缓存"** 选项卡：
- **缓存级别**：标准
- **浏览器缓存TTL**：4小时

### 2. 速度优化
在 **"速度"** 选项卡：
- ✅ **自动缩小**：CSS、HTML、JavaScript
- ✅ **Brotli压缩**：更好的压缩算法
- ✅ **早期提示**：提高页面加载速度

### 3. 网络优化
- ✅ **HTTP/2**：默认启用
- ✅ **0-RTT连接恢复**：加快重连速度

---

## 🛡️ 第六步：安全设置

### 1. 防火墙规则
在 **"安全性"** 选项卡：
- **安全级别**：中等
- **质询通过时间**：30分钟

### 2. DDoS防护
- ✅ **DDoS防护**：自动启用
- ✅ **速率限制**：可根据需要配置

---

## 📱 第七步：小程序域名配置

### 微信小程序后台设置

1. 登录 [微信公众平台](https://mp.weixin.qq.com)
2. 进入小程序后台
3. 点击 **"开发"** → **"开发管理"** → **"开发设置"**
4. 在 **"服务器域名"** 中配置：

| 类型 | 域名 |
|------|------|
| request合法域名 | `https://calorietracker.top` |
| uploadFile合法域名 | `https://calorietracker.top` |
| downloadFile合法域名 | `https://calorietracker.top` |

---

## ✅ 第八步：验证配置

### 1. DNS解析验证
```bash
# 本地执行命令验证
nslookup calorietracker.top
ping calorietracker.top
```

### 2. HTTPS访问验证
```bash
# 验证HTTPS是否正常
curl -I https://calorietracker.top/health
```

### 3. 小程序测试
在微信开发者工具中测试API调用是否正常。

---

## 🎯 配置完成检查清单

- [ ] 域名已添加到Cloudflare
- [ ] DNS记录配置正确（A记录和CNAME记录）
- [ ] 所有记录都开启了代理状态（🟠）
- [ ] 域名服务器已更新为Cloudflare
- [ ] SSL/TLS模式设置为"完全"
- [ ] 启用了"始终使用HTTPS"
- [ ] 性能优化功能已开启
- [ ] 微信小程序域名白名单已配置
- [ ] 测试访问正常

---

## 🔧 常见问题排查

### Q1: 域名无法访问
**可能原因：**
- DNS还未生效（需要等待24小时）
- 代理状态未开启
- 服务器防火墙阻挡

**解决方案：**
```bash
# 检查DNS解析
nslookup calorietracker.top

# 检查服务器状态
curl -I http://59.110.150.196/health
```

### Q2: SSL证书错误
**可能原因：**
- SSL模式配置错误
- 源服务器未正确配置

**解决方案：**
- 确保SSL模式为"完全"
- 检查nginx配置是否正确

### Q3: 小程序API调用失败
**可能原因：**
- 域名未添加到微信白名单
- API地址配置错误

**解决方案：**
- 检查小程序后台域名配置
- 验证constants.js中的API地址

---

## 📞 技术支持

如果遇到问题：

1. **查看Cloudflare分析面板**：了解流量和错误情况
2. **检查nginx日志**：`docker-compose logs nginx`
3. **验证DNS传播**：使用在线工具检查DNS状态
4. **测试服务器直连**：使用IP地址测试服务是否正常

---

## 🎉 配置成功标志

当您看到以下情况时，说明配置成功：

1. ✅ `https://calorietracker.top` 可以正常访问
2. ✅ 浏览器地址栏显示安全锁图标
3. ✅ 小程序可以正常调用API
4. ✅ 图片文件可以正常加载

**恭喜！您的"食刻卡路里"项目已成功配置新域名！** 🎊 